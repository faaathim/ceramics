{% extends "base.html" %}
{% load static %}
{% block top %}{% include "user_navbar.html" %}{% endblock %}

{% block content %}
<div class="container product-detail">
  <nav class="breadcrumbs">
    {% for name, url in breadcrumbs %}
      {% if url %}
        <a href="{{ url }}">{{ name }}</a> &raquo;
      {% else %}
        <span>{{ name }}</span>
      {% endif %}
    {% endfor %}
  </nav>

  <div class="product-main" style="display:flex; gap:20px;">
    <div class="gallery" style="width:420px;">
      <div class="main-image">
        {% if product.main_image %}
          <img id="zoom-image" src="{{ product.main_image.url }}" alt="{{ product.name }}" style="width:400px; height:400px; object-fit:cover;">
        {% elif product.images.first %}
          <img id="zoom-image" src="{{ product.images.first.image.url }}" alt="{{ product.name }}" style="width:400px; height:400px; object-fit:cover;">
        {% endif %}
      </div>
      <div class="thumbs">
        {% for img in product.images.all %}
          <img class="thumb" src="{{ img.image.url }}" width="60" height="60" style="object-fit:cover; cursor:pointer;" data-src="{{ img.image.url }}">
        {% endfor %}
      </div>
    </div>

    <div class="details" style="flex:1;">
      <h1>{{ product.name }}</h1>

      <div class="rating">
        <strong>{{ avg_rating }}</strong> / 5 ({{ review_count }} reviews)
      </div>

      <div class="price">
        <!-- Placeholder for discounts: if you implement discounts, display here -->
        <span class="current-price">₹{{ product.price }}</span>
      </div>

      <div class="stock">
        {% if product.stock|default:0 > 0 %}
          <span class="in-stock">In stock ({{ product.stock }})</span>
        {% else %}
          <span class="out-of-stock">Sold out</span>
        {% endif %}
      </div>

      <div class="description">
        <h3>Highlights</h3>
        <p>{{ product.description|linebreaksbr }}</p>
      </div>

      <div class="actions">
        {% if product.stock|default:0 > 0 %}
          <form method="post" action="#">
            {% csrf_token %}
            <label>Quantity</label>
            <input type="number" name="qty" value="1" min="1" max="{{ product.stock }}">
            <button type="submit">Add to cart</button>
          </form>
        {% else %}
          <button disabled>Sold out</button>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ✅ Fixed reviews section -->
  <section class="reviews">
    <h3>Reviews ({{ review_count }})</h3>
    {% for r in product.reviews.all|slice:":5" %}
      {% if r.is_approved %}
        <div class="review">
          {% if r.user %}
            <strong>{{ r.user.get_full_name|default:r.user.username }}</strong>
          {% else %}
            <strong>Anonymous</strong>
          {% endif %}
          <span>{{ r.rating }} / 5</span>
          <p>{{ r.title }}</p>
          <p>{{ r.body }}</p>
        </div>
      {% endif %}
    {% empty %}
      <p>No reviews yet.</p>
    {% endfor %}
  </section>

  <section class="related">
    <h3>Related Products</h3>
    <div class="grid">
      {% for rp in related_products %}
        <a href="{% url 'product_management:product_detail' rp.pk %}" class="product-card">
          {% if rp.main_image %}
            <img src="{{ rp.main_image.url }}" width="160" height="160">
          {% endif %}
          <div>{{ rp.name }}</div>
          <div>₹{{ rp.price }}</div>
        </a>
      {% endfor %}
    </div>
  </section>
</div>

<script>
// simple image thumb click -> replace main and enable simple zoom by increasing size on mousemove
document.querySelectorAll('.thumb').forEach(function(t){
  t.addEventListener('click', function(){ document.getElementById('zoom-image').src = this.dataset.src; });
});

// basic zoom behavior: when hover, scale image
const zoomImg = document.getElementById('zoom-image');
if (zoomImg) {
  zoomImg.addEventListener('mouseenter', function(){ this.style.transform = 'scale(1.05)'; this.style.transition='transform .15s'; });
  zoomImg.addEventListener('mouseleave', function(){ this.style.transform = 'scale(1)'; });
}
</script>

{% endblock %}
